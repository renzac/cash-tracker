<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Antigravity Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono:wght@500&display=swap"
        rel="stylesheet">
    <!-- Placeholder for icons -->
    <style>
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');

        body {
            font-family: 'Inter', sans-serif;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen overflow-hidden">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-[2000] bg-slate-950 flex items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-8 animate-fade-in">
            <div class="text-center">
                <h1
                    class="text-4xl font-bold font-orbitron text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-500">
                    ANTIGRAVITY</h1>
                <p class="text-slate-400 mt-2">Finance Core</p>
            </div>

            <form id="login-form" class="space-y-4" autocomplete="off">
                <div>
                    <input type="text" id="username" placeholder="Username" autocomplete="username"
                        class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all text-lg"
                        required>
                </div>
                <div>
                    <input type="password" id="password" placeholder="Password" autocomplete="current-password"
                        class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all text-lg"
                        required>
                </div>
                <div class="flex items-center justify-between">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="remember-me"
                            class="w-4 h-4 rounded border-slate-800 bg-slate-900 text-sky-500">
                        <span class="text-sm text-slate-400">Remember Me</span>
                    </label>
                </div>
                <button type="submit"
                    class="w-full bg-sky-500 hover:bg-sky-400 text-slate-950 font-bold py-3 rounded-xl transition-all transform active:scale-95 text-lg">
                    Login
                </button>
            </form>

            <div id="biometric-login-area" class="hidden text-center space-y-4">
                <div class="h-px bg-slate-800 w-full"></div>
                <button id="biometric-login-btn"
                    class="flex items-center justify-center space-x-2 w-full text-sky-400 py-2 hover:text-sky-300 transition-all">
                    <i class="fas fa-fingerprint text-2xl"></i>
                    <span>Login with Biometrics</span>
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-content" class="hidden flex h-screen">

        <!-- Sidebar (Desktop) -->
        <aside class="hidden lg:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 space-y-8">
            <h2 class="text-xl font-bold font-orbitron text-sky-400">AG FINANCE</h2>
            <nav class="flex-1 space-y-2">
                <button data-view="transactions"
                    class="nav-link active w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all">
                    <i class="fas fa-exchange-alt"></i><span>Transactions</span>
                </button>
                <button data-view="ledgers"
                    class="nav-link w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all">
                    <i class="fas fa-list-ul"></i><span>Ledgers</span>
                </button>
                <button data-view="accounts"
                    class="nav-link w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all">
                    <i class="fas fa-university"></i><span>Accounts</span>
                </button>
                <button id="admin-nav" data-view="admin"
                    class="hidden nav-link w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all">
                    <i class="fas fa-user-shield"></i><span>Admin</span>
                </button>
            </nav>
            <div class="p-2 bg-slate-800/30 rounded-xl space-y-1">
                <button id="admin-groups-btn" data-view="ledger-groups"
                    class="hidden nav-link w-full flex items-center space-x-3 px-3 py-2 text-xs rounded-lg transition-all opacity-70 hover:opacity-100">
                    <i class="fas fa-layer-group"></i><span>Groups</span>
                </button>
            </div>
            <button id="logout-btn"
                class="flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-rose-500 transition-all">
                <i class="fas fa-sign-out-alt"></i><span>Logout</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-950">

            <!-- Top Header (Contextual) -->
            <header
                class="flex items-center justify-between p-4 lg:p-6 bg-slate-950/50 backdrop-blur-md border-b border-slate-800 pt-safe z-50">
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="w-2 h-2 rounded-full bg-slate-700"
                        title="Checking connection..."></div>
                    <span id="current-view-title" class="text-xl font-semibold">Transactions</span>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button id="global-search-btn" onclick="window.AppLogic.showGlobalSearch()"
                        class="hidden md:flex text-slate-400 hover:text-sky-400 active:scale-90 transition-all p-3 -m-1"
                        title="Search Ledgers & Accounts">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                    <span id="display-date" class="text-slate-400 text-sm block"></span>
                    <button id="summary-btn"
                        class="hidden md:block bg-indigo-500/20 text-indigo-400 px-3 py-1.5 rounded-full text-xs md:text-sm font-semibold border border-indigo-500/30">
                        Summary
                    </button>
                    <button id="mobile-logout-btn"
                        class="hidden text-slate-400 hover:text-rose-500 transition-all p-3 -m-1">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Scrollable View Area -->
            <div id="view-container" class="flex-1 overflow-y-auto pb-24 lg:pb-6">

                <!-- Transactions View -->
                <div id="view-transactions" class="view-content p-4 lg:p-6 space-y-6">
                    <!-- Form Container -->
                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6 shadow-xl">
                        <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs text-slate-500 ml-1">Date</label>
                                <input type="date" id="tx-date"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-slate-500 ml-1">Type</label>
                                <select id="tx-type"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500">
                                    <option value="expense" class="text-rose-400">Expense</option>
                                    <option value="income" class="text-emerald-400">Income</option>
                                    <option value="contra" class="text-sky-400">Contra</option>
                                </select>
                            </div>
                            <div id="ledger-field" class="space-y-1">
                                <label class="text-xs text-slate-500 ml-1">Ledger</label>
                                <select id="tx-ledger"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500 mono-select">
                                    <option value="">Select Ledger</option>
                                </select>
                            </div>
                            <div id="account-field" class="space-y-1">
                                <label id="tx-account-label" class="text-xs text-slate-500 ml-1">Account</label>
                                <select id="tx-account"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500 mono-select">
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                            <div id="contra-to-field" class="hidden space-y-1">
                                <label class="text-xs text-slate-500 ml-1">To Account/Ledger</label>
                                <select id="tx-to"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500 mono-select">
                                    <option value="">Select Target</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs text-slate-500 ml-1">Amount</label>
                                <input type="number" step="0.001" id="tx-amount" placeholder="0.000"
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500 font-orbitron text-lg">
                            </div>
                            <div class="md:col-span-2 lg:col-span-2 space-y-1">
                                <label class="text-xs text-slate-500 ml-1">Remark</label>
                                <input type="text" id="tx-remark" placeholder="Note..."
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-sky-500">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" id="save-tx-btn"
                                    class="w-full h-12 bg-sky-500 hover:bg-sky-400 text-slate-950 font-bold rounded-xl shadow-lg shadow-sky-500/20 transition-all flex items-center justify-center space-x-2">
                                    <i class="fas fa-plus"></i><span>Save Entry</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- History -->
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <h3 class="text-lg font-semibold text-slate-300">Recent Transactions</h3>
                            <div class="flex items-center space-x-2">
                                <div class="relative group flex-1 sm:w-48 lg:w-64">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 group-focus-within:text-sky-500 transition-colors"></i>
                                    <input type="text" id="history-search" placeholder="Search..."
                                        class="w-full bg-slate-900/80 border border-slate-800 rounded-lg pl-9 pr-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-sky-500 transition-all">
                                </div>
                                <input type="date" id="history-date-filter"
                                    class="bg-slate-900/80 border border-slate-800 rounded-lg px-3 py-1.5 text-sm text-slate-300 focus:outline-none focus:ring-1 focus:ring-sky-500 transition-all">
                                <button id="filter-btn" class="text-slate-500 hover:text-slate-300 transition-all p-2">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div id="tx-history-list" class="space-y-3">
                            <!-- JS will populate -->
                        </div>
                    </div>
                </div>

                <!-- Other views hidden initially -->
                <div id="view-ledgers" class="view-content hidden p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold font-orbitron text-slate-100">Ledgers</h2>
                        <button onclick="AppLogic.syncBalances()"
                            class="p-3 bg-slate-800 text-slate-400 rounded-2xl hover:bg-slate-700 transition-all flex items-center space-x-2 border border-slate-700 shadow-lg"
                            title="Sync logic to fix old data">
                            <i class="fas fa-sync-alt"></i>
                            <span class="text-xs font-bold uppercase hidden sm:inline">Sync Logic</span>
                        </button>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6 mb-6">
                        <h3 class="text-lg font-medium mb-4 text-slate-300">Add New Ledger</h3>
                        <form id="ledger-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" id="ledger-name" placeholder="Ledger Name (e.g. Fuel)"
                                class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5">
                            <select id="ledger-group-select"
                                class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5">
                                <option value="">Select Group</option>
                            </select>
                            <input type="number" step="0.001" id="ledger-opening-balance"
                                placeholder="Opening Balance (0.000)"
                                class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 font-orbitron">
                            <button type="submit"
                                class="lg:col-span-3 bg-sky-500 text-slate-950 px-6 py-2.5 rounded-xl font-bold">Create</button>
                        </form>
                    </div>
                    <div id="ledger-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="view-ledger-groups" class="view-content hidden p-4 lg:p-6 text-slate-100">
                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6 mb-6">
                        <h3 class="text-lg font-medium mb-4">Add New Ledger Group</h3>
                        <form id="ledger-group-form" class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="group-name" placeholder="Group Name (e.g. Investments)"
                                class="flex-1 bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5">
                            <button type="submit"
                                class="bg-sky-500 text-slate-950 px-6 py-2.5 rounded-xl font-bold">Create</button>
                        </form>
                    </div>
                    <div id="ledger-group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="view-accounts" class="view-content hidden p-4 lg:p-6">
                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6 mb-6">
                        <h3 class="text-lg font-medium mb-4">Add New Account</h3>
                        <form id="account-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" id="account-name" placeholder="Account Name (e.g. KFH)"
                                class="bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5">
                            <input type="number" step="0.001" id="account-opening-balance"
                                placeholder="Opening Balance (0.000)"
                                class="bg-slate-950 border border-slate-800 rounded-xl px-4 py-2.5 font-orbitron">
                            <button type="submit"
                                class="bg-sky-500 text-slate-950 px-6 py-2.5 rounded-xl font-bold">Create</button>
                        </form>
                    </div>
                    <div id="account-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="view-admin" class="view-content hidden p-4 lg:p-6 space-y-6">
                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6">
                        <h3 class="text-lg font-medium mb-4 text-slate-300">Data Portability</h3>
                        <p class="text-sm text-slate-500 mb-6">Backup your entire financial database to a file or
                            restore it on a new device.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.AppLogic.exportData()"
                                class="flex items-center justify-center space-x-3 bg-slate-800 hover:bg-slate-700 text-slate-100 px-6 py-4 rounded-2xl transition-all border border-slate-700 shadow-xl group">
                                <i
                                    class="fas fa-file-export text-sky-400 group-hover:scale-110 transition-transform"></i>
                                <div class="text-left">
                                    <div class="font-bold">Export Database</div>
                                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-orbitron">
                                        Download JSON</div>
                                </div>
                            </button>
                            <button onclick="window.AppLogic.triggerImport()"
                                class="flex items-center justify-center space-x-3 bg-slate-800 hover:bg-slate-700 text-slate-100 px-6 py-4 rounded-2xl transition-all border border-slate-700 shadow-xl group">
                                <i
                                    class="fas fa-file-import text-emerald-400 group-hover:scale-110 transition-transform"></i>
                                <div class="text-left">
                                    <div class="font-bold">Import Database</div>
                                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-orbitron">
                                        Upload JSON</div>
                                </div>
                            </button>
                        </div>
                        <input type="file" id="import-input" class="hidden" accept=".json"
                            onchange="window.AppLogic.importData(event)">

                        <div class="mt-6 pt-6 border-t border-slate-800">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Cloud Sync</h4>
                            <button onclick="window.AppLogic.refreshFromCloud()"
                                class="w-full flex items-center justify-center space-x-3 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 px-6 py-4 rounded-2xl transition-all border border-indigo-500/20 shadow-xl group">
                                <i class="fas fa-cloud-download-alt group-hover:scale-110 transition-transform"></i>
                                <div class="text-left">
                                    <div class="font-bold">Refresh from Cloud</div>
                                    <div class="text-[10px] uppercase tracking-widest font-orbitron text-indigo-400/70">
                                        Pull latest data from Supabase</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-800 rounded-3xl p-6">
                        <h3 class="text-lg font-medium mb-4 text-slate-300">Manage Users</h3>
                        <div id="user-management-list" class="space-y-4"></div>
                    </div>
                </div>

            </div>

            <!-- Bottom Nav (Mobile) -->
            <nav
                class="lg:hidden fixed bottom-0 left-0 right-0 bg-slate-950/80 backdrop-blur-xl border-t border-slate-800 flex justify-around items-center h-20 px-2 pb-safe z-[2000]">
                <button data-view="transactions" class="mobile-nav-link active flex flex-col items-center space-y-1">
                    <i class="fas fa-exchange-alt text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Entries</span>
                </button>
                <button onclick="window.AppLogic.showGlobalSearch()"
                    class="mobile-nav-link flex flex-col items-center space-y-1 text-slate-500">
                    <i class="fas fa-search text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Search</span>
                </button>
                <button data-view="ledgers" class="mobile-nav-link flex flex-col items-center space-y-1 text-slate-500">
                    <i class="fas fa-list-ul text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Ledger</span>
                </button>
                <button data-view="accounts"
                    class="mobile-nav-link flex flex-col items-center space-y-1 text-slate-500">
                    <i class="fas fa-university text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Banks</span>
                </button>
                <button id="mobile-summary-btn"
                    class="mobile-nav-link flex flex-col items-center space-y-1 text-slate-500">
                    <i class="fas fa-chart-pie text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Summary</span>
                </button>
                <button id="mobile-logout-nav"
                    class="mobile-nav-link flex flex-col items-center space-y-1 text-slate-500">
                    <i class="fas fa-sign-out-alt text-lg"></i>
                    <span class="text-[9px] font-medium uppercase tracking-wider">Logout</span>
                </button>
            </nav>
        </main>
    </div>

    <!-- Modals (Summary, Filter, Biometrics) -->
    <div id="modal-container"
        class="hidden fixed inset-0 z-[3000] bg-slate-950/60 backdrop-blur-sm flex items-end md:items-center justify-center p-4">
        <!-- Content injected via JS -->
    </div>

    <!-- Toast UI -->
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[4000] space-y-2 pointer-events-none">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="store.js?v=10"></script>
    <script src="logic.js?v=10"></script>
    <script src="auth.js?v=10"></script>
    <script>
        if ('serviceWorker' in navigator && location.protocol.startsWith('http')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.error('SW Registration failed', err));
            });
        }
    </script>
</body>

</html>